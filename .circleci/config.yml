version: 2 # use CircleCI 2.0
jobs: # a collection of steps
  build: # runs not using Workflows must have a `build` job as entry point
    docker: # run the steps with Docker
      - image: ankurpshah/newman-with-htmlextra
      # - image: ankurpshah/restful-booker
    
    steps: # a collection of executable commands
      - checkout # check out source code to working directory
      - setup_remote_docker

      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.03.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin

      - run:
          name: create docker network
          command: docker network create grid

      - run:
          name: Run restful-booker app
          command: docker run -d --rm -p 3001:3001 --net grid --name restful-booker ankurpshah/restful-booker

      - run:
          name: Run API test
          command: newman run collection/smoke.postman_collection.json --environment env/docker.postman_environment.json --reporters htmlextra,junit --reporter-htmlextra-export report/html/smoke.html --reporter-htmlextra-title "Smoke Test" --reporter-junit-export report/junit/smoke-report.xml
      
      - store_test_results:
          path: ~/report/junit
      - store_artifacts:
          path: ~/report/html